# Руководство по устранению неполадок telegram-audio-bot

## Обзор

В этом документе описаны типичные проблемы, которые могут возникнуть при использовании или развертывании Telegram-бота для улучшения аудио файлов, а также рекомендации по их устранению.

## Проблемы запуска и работы бота

### 1. Бот не запускается

**Симптомы:**
- Ошибка при запуске: "Invalid token" или "Unauthorized"
- Контейнер выходит с ошибкой

**Возможные причины и решения:**
- Неправильный токен бота:
  1. Проверьте значение переменной `BOT_TOKEN`
  2. Убедитесь, что токен скопирован без лишних пробелов
  3. Пересоздайте бота через @BotFather при необходимости

- Проблемы с зависимостями:
  1. Проверьте файл `requirements.txt`
  2. Убедитесь, что все зависимости совместимы
  3. Пересоберите Docker-образ: `docker-compose build`

### 2. Бот не отвечает на команды

**Симптомы:**
- Бот онлайн, но не реагирует на команды
- Нет ответа на /start

**Возможные причины и решения:**
- Проблемы с сетью:
  1. Проверьте подключение к интернету
  2. Убедитесь, что порты не заблокированы
  3. Проверьте настройки брандмауэра

- Проблемы с webhook/polling:
  1. Убедитесь, что бот использует polling (в коде)
  2. Проверьте логи на наличие ошибок соединения

### 3. Ошибки при обработке аудио

**Симптомы:**
- Ошибка "Error processing audio"
- Некорректное качество результата

**Возможные причины и решения:**
- Неподдерживаемый формат файла:
  1. Проверьте поддерживаемые форматы в pydub
  2. Убедитесь, что файл не поврежден
  3. Попробуйте другой файл для тестирования

- Проблемы с ffmpeg:
  1. Убедитесь, что ffmpeg установлен в контейнере
  2. Проверьте логи на наличие ошибок кодека
  3. Установите дополнительные кодеки при необходимости

## Проблемы с производительностью

### 1. Медленная обработка файлов

**Симптомы:**
- Долгая обработка аудио
- Высокое потребление CPU

**Возможные причины и решения:**
- Большие файлы:
  1. Уменьшите размер обрабатываемых файлов
  2. Увеличьте лимит времени ожидания

- Недостаток ресурсов:
  1. Проверьте использование CPU и RAM
  2. Увеличьте ресурсы сервера при необходимости
  3. Рассмотрите масштабирование

### 2. Высокое потребление памяти

**Симптомы:**
- Увеличение использования RAM
- Ошибки "Out of memory"

**Возможные причины и решения:**
- Утечки памяти:
  1. Проверьте корректную очистку временных файлов
  2. Убедитесь, что сессии пользователей удаляются
  3. Оптимизируйте обработку больших файлов

- Большое количество одновременных обработок:
  1. Ограничьте количество одновременных задач
  2. Внедрите очередь задач

## Проблемы безопасности

### 1. Обработка вредоносных файлов

**Симптомы:**
- Подозрительная активность
- Ненормальное поведение контейнера

**Возможные причины и решения:**
- Убедитесь, что включена проверка размера файлов
- Проверьте валидацию формата аудио
- Обновите зависимости безопасности
- Используйте антивирус для сканирования файлов (при необходимости)

### 2. Утечка данных

**Симптомы:**
- Несанкционированный доступ к файлам
- Появление файлов в непредусмотренных местах

**Возможные причины и решения:**
- Проверьте права доступа к директориям
- Убедитесь, что временные файлы удаляются
- Проверьте настройки Docker-контейнера
- Используйте отдельного пользователя в контейнере

## Проблемы с Docker

### 1. Ошибки сборки образа

**Симптомы:**
- Ошибка при выполнении `docker-compose build`
- Ошибки установки зависимостей

**Возможные причины и решения:**
- Проблемы с кэшем Docker:
  1. Очистите кэш: `docker builder prune`
  2. Пересоберите без кэша: `docker-compose build --no-cache`

- Проблемы с сетью:
  1. Проверьте подключение к интернету
  2. Убедитесь, что Docker может получить доступ к репозиториям

### 2. Проблемы с volumes

**Симптомы:**
- Нет доступа к файлам в volume
- Ошибки при сохранении файлов

**Возможные причины и решения:**
- Проверьте права доступа к директориям на хосте
- Убедитесь, что директории существуют
- Проверьте настройки SELinux (для систем на базе Red Hat)

## Проблемы с аудио-обработкой

### 1. Плохое качество результата

**Симптомы:**
- Искажения в обработанном аудио
- Потеря качества

**Возможные причины и решения:**
- Проверьте параметры обработки:
  1. Уровень усиления
  2. Параметры компрессии
  3. Настройки нормализации

- Проблемы с исходным файлом:
  1. Проверьте качество исходного аудио
  2. Убедитесь, что файл не поврежден

### 2. Ошибки при создании графиков

**Симптомы:**
- Ошибки при отправке графиков
- Некорректное отображение

**Возможные причины и решения:**
- Проверьте зависимости matplotlib
- Убедитесь, что используется правильный бэкенд
- Проверьте формат сохранения изображений

## Диагностические команды

### Проверка состояния системы

```bash
# Проверка состояния контейнеров
docker-compose ps

# Проверка использования ресурсов
docker stats telegram-audio-bot

# Просмотр логов
docker-compose logs audio-bot

# Проверка свободного места
df -h

# Проверка использования памяти
docker exec telegram-audio-bot free -h
```

### Диагностика аудио-обработки

```bash
# Проверка установленных аудио библиотек
docker exec telegram-audio-bot python -c "import pydub; print(pydub.__version__)"

# Проверка ffmpeg
docker exec telegram-audio-bot ffmpeg -version

# Проверка доступности файлов
docker exec telegram-audio-bot ls -la /app/temp
```

## Рекомендации по мониторингу

### Ключевые метрики для отслеживания

1. **Время отклика бота**
   - Нормальное: < 2 секунды
   - Критическое: > 10 секунд

2. **Количество активных сессий**
   - Нормальное: < 100 одновременных
   - Критическое: > 500 одновременных

3. **Использование памяти**
   - Нормальное: < 70% от доступной
   - Критическое: > 90% от доступной

4. **Размер временной директории**
   - Нормальное: < 1GB
   - Критическое: > 5GB

### Автоматические проверки

Создайте скрипт `health_check.py`:

```python
import os
import shutil
import psutil
from datetime import datetime

def check_system_health():
    """Проверка состояния системы"""
    # Проверка дискового пространства
    temp_size = shutil.disk_usage("/app/temp")
    disk_usage = (temp_size.used / temp_size.total) * 100
    
    # Проверка памяти
    memory_usage = psutil.virtual_memory().percent
    
    # Проверка количества файлов во временной директории
    temp_files_count = len(os.listdir("/app/temp"))
    
    print(f"Время проверки: {datetime.now()}")
    print(f"Использование диска во временной директории: {disk_usage:.2f}%")
    print(f"Использование памяти: {memory_usage:.2f}%")
    print(f"Количество временных файлов: {temp_files_count}")
    
    if disk_usage > 80:
        print("⚠️  Высокое использование дискового пространства!")
    
    if memory_usage > 85:
        print("⚠️  Высокое использование памяти!")
    
    if temp_files_count > 1000:
        print("⚠️  Большое количество временных файлов!")

if __name__ == "__main__":
    check_system_health()
```

## План действий при возникновении проблем

1. **Определение проблемы**
   - Сбор информации из логов
   - Определение типа ошибки
   - Оценка влияния на пользователей

2. **Локализация проблемы**
   - Проверка состояния контейнеров
   - Анализ метрик производительности
   - Проверка сетевых соединений

3. **Устранение проблемы**
   - Применение соответствующих решений
   - Тестирование исправления
   - Мониторинг результата

4. **Документирование**
   - Запись проблемы и решения
   - Обновление этого руководства
   - Предотвращение повторения

## Контакты для поддержки

Если проблема не может быть решена с помощью этого руководства:

- Создайте issue в репозитории проекта
- Проверьте существующие issue на наличие аналогичных проблем
- Предоставьте подробное описание проблемы с логами