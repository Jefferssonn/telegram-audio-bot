# Тестирование проекта telegram-audio-bot

## Обзор

В этом документе описаны рекомендации по тестированию различных аспектов бота для обеспечения его надежности и корректной работы.

## Типы тестов

### 1. Модульные тесты

Для каждого класса должны быть созданы модульные тесты:

#### AudioProcessor
- Тестирование анализа аудио (различные форматы, частоты дискретизации)
- Тестирование улучшения аудио (проверка корректности нормализации и компрессии)
- Тестирование конвертации моно в стерео
- Тестирование создания графиков сравнения
- Тестирование проверки метки "[ENHANCED]"

#### UserSessionManager
- Тестирование создания сессий
- Тестирование получения сессий
- Тестирование очистки просроченных сессий
- Тестирование TTL сессий

#### AudioBot
- Тестирование обработки команд
- Тестирование обработки аудио файлов
- Тестирование различных сценариев действий

### 2. Интеграционные тесты

- Тестирование полного цикла работы бота
- Тестирование обработки различных форматов аудио
- Тестирование обработки файлов разных размеров
- Тестирование параллельной обработки от разных пользователей

### 3. Тесты безопасности

- Тестирование ограничения размера файлов
- Тестирование обработки некорректных файлов
- Тестирование обработки файлов с вредоносным содержимым
- Тестирование управления сессиями

## Рекомендуемые тестовые сценарии

### Позитивные сценарии

1. **Анализ аудио**
   - Отправка аудио файла
   - Выбор действия "Анализ качества"
   - Получение подробной информации о качестве

2. **Улучшение звука**
   - Отправка аудио файла
   - Выбор действия "Улучшить звук"
   - Получение улучшенного файла и графика сравнения

3. **Конвертация моно в стерео**
   - Отправка моно аудио файла
   - Выбор действия "Моно → Стерео"
   - Получение стерео версии файла

4. **Полная обработка**
   - Отправка аудио файла
   - Выбор действия "Полная обработка"
   - Получение полностью обработанного файла и результатов

### Негативные сценарии

1. **Файл слишком большой**
   - Отправка файла больше 50MB
   - Проверка получения сообщения об ошибке

2. **Повторная обработка**
   - Отправка файла с меткой "[ENHANCED]"
   - Проверка получения предупреждения

3. **Неподдерживаемый формат**
   - Отправка неаудио файла
   - Проверка получения сообщения об ошибке

4. **Истечение сессии**
   - Выбор действия
   - Ожидание истечения TTL
   - Отправка файла
   - Проверка запроса выбора действия заново

## Рекомендации по реализации тестов

### Используемые библиотеки
- `unittest` или `pytest` для написания тестов
- `unittest.mock` для мокирования внешних зависимостей
- `telegram.ext.Application` для тестирования обработчиков

### Структура тестов
```
tests/
├── test_audio_processor.py
├── test_session_manager.py
├── test_bot_handlers.py
├── test_integration.py
└── fixtures/
    ├── sample_mono.wav
    ├── sample_stereo.mp3
    └── large_file.mock
```

### Пример теста
```python
import unittest
from unittest.mock import Mock, patch
from bot_refactored import AudioProcessor

class TestAudioProcessor(unittest.TestCase):
    def test_analyze_audio_returns_correct_metrics(self):
        # Подготовка
        audio_segment = Mock()
        audio_segment.channels = 2
        audio_segment.frame_rate = 44100
        audio_segment.__len__.return_value = 44100
        audio_segment.sample_width = 2
        
        # Выполнение
        result = AudioProcessor.analyze_audio(audio_segment)
        
        # Проверка
        self.assertEqual(result['channels'], 2)
        self.assertEqual(result['sample_rate'], 44100)
        self.assertEqual(result['is_mono'], False)
        self.assertIsInstance(result['quality'], float)
```

## Покрытие кода

Рекомендуется использовать `coverage.py` для измерения покрытия кода тестами. Цель - достичь не менее 80% покрытия.

## Автоматизация тестирования

Для проекта рекомендуется настроить CI/CD пайплайн с автоматическим запуском тестов при каждом коммите:

```yaml
name: Tests
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.11
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install pytest coverage
    - name: Run tests
      run: |
        coverage run -m pytest
        coverage report
```